<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FT Image Mixer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mixer-style.css') }}">
    <style>
       /* Ensure no scrolling */
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
    width: 100%;
}

/* Simple mode toggle */
.mode-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 12px;
}

.mode-toggle label {
    color: #ddd;
    font-weight: bold;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #333;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #4CAF50;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.mode-label {
    font-size: 11px;
    color: #aaa;
    margin-left: 5px;
}

/* Make viewports relative for overlay */
.viewport.ft-viewport {
    position: relative;
    overflow: hidden;
}

.region-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none; /* Default to none, JS will control when needed */
}

/* Adjust card footers */
.card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 8px;
    min-height: 32px;
    position: relative; /* For positioning the region button */
}

.card-footer span {
    font-weight: bold;
    min-width: 50px;
    font-size: 12px;
}

.card-footer select {
    flex: 1;
    margin: 0 5px;
    font-size: 11px;
    padding: 2px;
}

.region-toggle {
    min-width: 60px;
}

/* Region rectangle styles - UPDATED FOR NEW JS */
.region-rectangle {
    position: absolute;
    pointer-events: auto;
    cursor: move;
    box-sizing: border-box;
}

/* Inner region style */
.region-rectangle.inner {
    border: 2px solid #4CAF50; /* Green border */
    background-color: rgba(76, 175, 80, 0.15);
    box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
}

/* Outer region style */
.region-rectangle.outer {
    border: 2px dashed #ff9800; /* Amber/orange dashed border */
    background-color: rgba(255, 152, 0, 0.15);
    box-shadow: 0 0 5px rgba(255, 152, 0, 0.5);
}

/* Region button styles - UPDATED */
.region-btn {
    padding: 3px 6px;
    font-size: 11px;
    border: 1px solid #555;
    cursor: pointer;
    border-radius: 3px;
    width: 100%;
    font-weight: bold;
    transition: background-color 0.2s;
    color: white;
    text-align: center;
    min-width: 80px;
    height: 24px;
}

/* Button colors */
.region-btn.inner {
    background-color: #4CAF50; /* Green for inner */
    border-color: #45a049;
}

.region-btn.outer {
    background-color: #ff9800; /* Orange for outer */
    border-color: #e68900;
    color: white;
}

.region-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Region instructions */
.region-instructions {
    font-size: 11px;
    color: #aaa;
    margin-top: 5px;
    text-align: center;
}

/* Adjust action column spacing */
.action-column {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.action-column label {
    font-size: 12px;
    margin-bottom: 2px;
}

.action-column select {
    font-size: 11px;
    padding: 3px;
}

/* Slider adjustments */
.slider-row span {
    font-size: 11px;
    min-width: 40px;
}

.slider-row input[type="range"] {
    width: 80px;
}

.column-header {
    font-size: 13px;
    padding: 5px 0;
}

</style>
</head>
<body>

    <!-- Top Section: Visuals -->
    <div class="main-stage">
        
        <!-- Left: Input Grid (2x2) -->
        <div class="input-grid">
            <!-- CARD 1 -->
            <div class="card">
                <div class="card-body">
                    <div class="viewport" ondblclick="upload(1)" onmousedown="startDrag(event, 'img1')">
                        <img id="img1">
                    </div>
                    <div class="viewport ft-viewport" id="viewport-compImg1">
                        <img id="compImg1" onmousedown="startDrag(event, 'compImg1')">
                        <div class="region-overlay" id="overlay-compImg1"></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span>Image 1</span>
                    <select id="sel1" onchange="updateCompView(1)">
                        <option value="mag">Magnitude</option>
                        <option value="phase">Phase</option>
                        <option value="real">Real</option>
                        <option value="imag">Imaginary</option>
                    </select>
                    <div class="region-toggle">
                        <button class="region-btn" onclick="toggleRegionType(1)" id="region-type1">Inner</button>
                    </div>
                </div>
            </div>

            <!-- CARD 2 -->
            <div class="card">
                <div class="card-body">
                    <div class="viewport" ondblclick="upload(2)" onmousedown="startDrag(event, 'img2')">
                        <img id="img2">
                    </div>
                    <div class="viewport ft-viewport" id="viewport-compImg2">
                        <img id="compImg2" onmousedown="startDrag(event, 'compImg2')">
                        <div class="region-overlay" id="overlay-compImg2"></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span>Image 2</span>
                    <select id="sel2" onchange="updateCompView(2)">
                        <option value="mag">Magnitude</option>
                        <option value="phase">Phase</option>
                        <option value="real">Real</option>
                        <option value="imag">Imaginary</option>
                    </select>
                    <div class="region-toggle">
                        <button class="region-btn" onclick="toggleRegionType(2)" id="region-type2">Inner</button>
                    </div>
                </div>
            </div>

            <!-- CARD 3 -->
            <div class="card">
                <div class="card-body">
                    <div class="viewport" ondblclick="upload(3)" onmousedown="startDrag(event, 'img3')">
                        <img id="img3">
                    </div>
                    <div class="viewport ft-viewport" id="viewport-compImg3">
                        <img id="compImg3" onmousedown="startDrag(event, 'compImg3')">
                        <div class="region-overlay" id="overlay-compImg3"></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span>Image 3</span>
                    <select id="sel3" onchange="updateCompView(3)">
                        <option value="mag">Magnitude</option>
                        <option value="phase">Phase</option>
                        <option value="real">Real</option>
                        <option value="imag">Imaginary</option>
                    </select>
                    <div class="region-toggle">
                        <button class="region-btn" onclick="toggleRegionType(3)" id="region-type3">Inner</button>
                    </div>
                </div>
            </div>

            <!-- CARD 4 -->
            <div class="card">
                <div class="card-body">
                    <div class="viewport" ondblclick="upload(4)" onmousedown="startDrag(event, 'img4')">
                        <img id="img4">
                    </div>
                    <div class="viewport ft-viewport" id="viewport-compImg4">
                        <img id="compImg4" onmousedown="startDrag(event, 'compImg4')">
                        <div class="region-overlay" id="overlay-compImg4"></div>
                    </div>
                </div>
                <div class="card-footer">
                    <span>Image 4</span>
                    <select id="sel4" onchange="updateCompView(4)">
                        <option value="mag">Magnitude</option>
                        <option value="phase">Phase</option>
                        <option value="real">Real</option>
                        <option value="imag">Imaginary</option>
                    </select>
                    <div class="region-toggle">
                        <button class="region-btn" onclick="toggleRegionType(4)" id="region-type4">Inner</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Output Grid (2x1) -->
        <div class="output-grid">
            <!-- OUTPUT PORT 1 -->
            <div class="card active-output" id="outCard1">
                <div class="card-body">
                    <div class="viewport" onmousedown="startDrag(event, 'outImg1')">
                        <img id="outImg1">
                    </div>
                    <div class="viewport" onmousedown="startDrag(event, 'outCompImg1')">
                        <img id="outCompImg1">
                    </div>
                </div>
                <div class="card-footer">
                    <label>
                        <input type="radio" name="outSel" value="1" checked onchange="selectOutput(1)">
                        Output 1
                    </label>
                    <select id="outSel1" onchange="updateOutputCompView(1)">
                        <option value="mag">Magnitude</option>
                        <option value="phase">Phase</option>
                        <option value="real">Real</option>
                        <option value="imag">Imaginary</option>
                    </select>
                </div>
            </div>
            
            <!-- OUTPUT PORT 2 -->
            <div class="card" id="outCard2">
                <div class="card-body">
                    <div class="viewport" onmousedown="startDrag(event, 'outImg2')">
                        <img id="outImg2">
                    </div>
                    <div class="viewport" onmousedown="startDrag(event, 'outCompImg2')">
                        <img id="outCompImg2">
                    </div>
                </div>
                <div class="card-footer">
                    <label>
                        <input type="radio" name="outSel" value="2" onchange="selectOutput(2)">
                        Output 2
                    </label>
                    <select id="outSel2" onchange="updateOutputCompView(2)">
                        <option value="mag">Magnitude</option>
                        <option value="phase">Phase</option>
                        <option value="real">Real</option>
                        <option value="imag">Imaginary</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Section: Controls -->
    <div class="control-panel">
        <div class="controls-row">
            
            <!-- Sliders Column A -->
            <div class="slider-column">
                <div class="column-header" id="labelColA">Magnitude</div>
                <div class="slider-row"><span>Img 1</span><input type="range" id="wa1" min="0" max="10" step="0.1" value="5"></div>
                <div class="slider-row"><span>Img 2</span><input type="range" id="wa2" min="0" max="10" step="0.1" value="5"></div>
                <div class="slider-row"><span>Img 3</span><input type="range" id="wa3" min="0" max="10" step="0.1" value="5"></div>
                <div class="slider-row"><span>Img 4</span><input type="range" id="wa4" min="0" max="10" step="0.1" value="5"></div>
            </div>

            <!-- Sliders Column B -->
            <div class="slider-column">
                <div class="column-header" id="labelColB">Phase</div>
                <div class="slider-row"><span>Img 1</span><input type="range" id="wb1" min="0" max="10" step="0.1" value="5"></div>
                <div class="slider-row"><span>Img 2</span><input type="range" id="wb2" min="0" max="10" step="0.1" value="5"></div>
                <div class="slider-row"><span>Img 3</span><input type="range" id="wb3" min="0" max="10" step="0.1" value="5"></div>
                <div class="slider-row"><span>Img 4</span><input type="range" id="wb4" min="0" max="10" step="0.1" value="5"></div>
            </div>

            <!-- Settings Column -->
            <div class="action-column">
                <!-- Simple mode toggle -->
                <div class="mode-toggle">
                    <label class="switch">
                        <input type="checkbox" id="modeToggle" onchange="toggleMixingMode()">
                        <span class="slider"></span>
                    </label>
                    <span class="mode-label">Region Mode</span>
                </div>
                
                <label>Component Type</label>
                <select id="mixMode" onchange="updateMode()">
                    <option value="magnitude_phase">Magnitude / Phase</option>
                    <option value="real_imag">Real / Imaginary</option>
                </select>

                <!-- Region instructions (only show in region mode) -->
                <div class="region-instructions" id="regionInstructions">
                    Click & drag on FT images to draw regions
                </div>
                
                <button class="btn" onclick="requestMix()">Mix Images</button>
            </div>
        </div>
        <div class="progress-container"><div class="progress-fill" id="pbar"></div></div>
    </div>

    <input type="file" id="fileInput" hidden>

    <script src="{{ url_for('static', filename='js/ftmixer.js') }}"></script>
</body>
</html>